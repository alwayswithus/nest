<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kanbanBoard">

   <!-- 테스크 리스트 select -->
   <select id="selectAllTaskList" resultType="tasklistvo">
      <![CDATA[
         select tl.tasklist_no as tasklistNo, tl.tasklist_name as taskListName, tl.tasklist_order as tasklistOrder, tl.project_no projectNo
         from project p
         join tasklist tl on(p.project_no = tl.project_no)
         where p.project_no = #{projectNo}
         order by tl.tasklist_order
      ]]>
   </select>

   <!-- 테크스 select -->
   <select id="selectTasks" resultType="taskvo">
      <![CDATA[
          select a.task_no taskNo,
               date_format(a.task_start, '%Y-%m-%d %H:%i') as taskStart,
               date_format(a.task_end, '%Y-%m-%d %H:%i') as taskEnd,
               a.task_point taskPoint,
               a.task_label taskLabel,
               a.task_state taskState,
               a.task_contents taskContents,
               a.task_order taskOrder,
               a.tasklist_no tasklistNo,
               a.task_regdate taskRegdate,
               a.task_writer taskWriter,
               a.project_no projectNo,
               b.user_name userName
         from task a
         join user b on (a.task_writer = b.user_no)
         where tasklist_no = #{taskListNo}
          order by task_state, task_order desc
      ]]>
   </select>

   <!-- 체크리스트 select -->
   <select id="selectCheckList" resultType="checklistvo">
      <![CDATA[
         select checklist_no checklistNo,
               checklist_contents checklistContents,
               checklist_state checklistState,
               task_no taskNo
         from checklist
         where task_no = #{taskNo}
       ]]>
   </select>

   <!-- 태그 select -->
   <select id="selectTag" resultType="taglistvo">
      <![CDATA[
         select tl.tag_no tagNo, 
               tt.task_no taskNo, 
               tl.tag_name tagName, 
               tl.tag_color tagColor
         from tagtask tt 
         join taglist tl using(tag_no)
         where tt.task_no = #{taskNo}
       ]]>
   </select>

   <!-- 코멘트 select -->
   <select id="selectComments" resultType="commentvo">
      <![CDATA[
         select  a.comment_no commentNo,
               a.comment_regdate commentRegdate,
               a.comment_contents commentContents,
               a.comment_like commentLike,
               a.user_no userNo,
               a.task_no taskNo,
               a.file_no fileNo,
                 a.comment_state commentState,
                 b.user_name userName,
                 b.user_photo userPhoto,
                 b.user_email userEmail,
                 c.origin_name originName,
                 c.file_path filePath,
                 c.file_regdate fileRegdate,
                 c.file_state fileState
         from comment a
         join user b on(a.user_no = b.user_no)
         left join file c on(a.file_no = c.file_no)
         where a.task_no = #{taskNo}
       ]]>
   </select>

   <!-- 파일 select -->
   <select id="selectFile" resultType="filevo">
      <![CDATA[
         select file_no fileNo,
            origin_name originName,
            change_name changeName,
            file_path filePath,
            file_regdate fileRegdate,
            task_no taskNo,
            file_state fileState
         from file
         where task_no = #{taskNo}
       ]]>
   </select>

   <!-- 업무 유저 select -->
   <select id="selectMemberList" resultType="uservo">
      <![CDATA[
         select u.user_no userNo,
               u.user_regdate userRegdate,
               u.user_email userEmail,
               u.user_name userName,
               u.user_number userNumber,
               u.user_birth userBirth,
               u.user_title userTitle, 
               u.user_dept userDept, 
               u.user_photo userPhoto
         from user u
         join taskuser tu using(user_no)
         where task_no = #{taskNo}
       ]]>
   </select>
   
      <!-- 프로젝트 이름 select -->
   <select id="selectProjectTitle" resultType="string">
      <![CDATA[
        select project_title
		from project
		where project_no = #{projectNo}
       ]]>
   </select>

   <!-- 테스크 리스트 정렬 번호 select -->
   <select id="selectTaskListOrderNo" resultType="Long">
      <![CDATA[
            select max(tasklist_order)
            from tasklist
            where project_no = #{projectNo}
      ]]>
   </select>

   <!-- 테스크 리스트 insert -->
   <insert id="taskListAdd" parameterType="tasklistvo"> 
      <![CDATA[
         insert into tasklist values(null, #{taskListName}, #{taskListOrder}, #{projectNo},'T')
      ]]>
      <selectKey keyProperty="taskListNo" resultType="long"
         order="AFTER">
         select last_insert_id()
      </selectKey>
   </insert>

   <!-- 테스크 리스트 delete -->
   <update id="taskListDelete" parameterType="tasklistvo"> 
      <![CDATA[ 
         update tasklist
         set tasklist_state = 'F'
         where tasklist_no = #{taskListNo}
      ]]>
   </update>
   
   <update id="taskListInDelete" parameterType="Long">
   		<![CDATA[
			update task
			set task_state = 'del'
			where tasklist_no = #{taskListNo}	
   		]]>	
   </update>

   <!-- 테스크 리스트 삭제시 정렬 update -->
   <update id="taskListDeleteReOrder" parameterType="tasklistvo"> 
      <![CDATA[
         update tasklist
         set tasklist_order = tasklist_order - 1
         where tasklist_order > #{taskListOrder}
         and project_no = #{projectNo}   
      ]]>
   </update>

   <!-- 테스크 리스트 이름 update -->
   <update id="taskListEditName" parameterType="tasklistvo"> 
      <![CDATA[
         update tasklist
         set tasklist_name = #{taskListName}
         where tasklist_no = #{taskListNo}
      ]]>
   </update>

   <!-- 테스크리스트 DnD 정렬 update -->
   <update id="taskListDnDReOrder" parameterType="tasklistvo">
      <![CDATA[ 
         update tasklist
         set tasklist_order = #{taskListOrder}
         where tasklist_no = #{taskListNo}
      ]]>
   </update>
   
   <!-- 테스크 추가 -->
   <insert id="taskInsert" parameterType="HashMap">
      <![CDATA[
         insert into task 
         values(null, now(), null, null, 'rgb(223,223,223)', 'do', #{taskContents}, #{taskOrder}, now(), #{taskListNo}, #{projectNo}, #{taskWriter});
      ]]>
   <selectKey keyProperty = "taskNo" resultType="long" order="AFTER">
      select last_insert_id()
   </selectKey>
   </insert>
   
   <!-- 테스크 추가 후 정보 가져오기 -->
   <select id="taskSelect" resultType="taskvo">
      <![CDATA[
         select task_no taskNo,
               date_format(task_start, '%Y-%m-%d') as taskStart,
               date_format(task_end, '%Y-%m-%d') as taskEnd,
               task_point taskPoint,
               task_label taskLabel,
               task_state taskState,
               task_contents taskContents,
               task_order taskOrder,
               tasklist_no tasklistNo,
                    task_regdate taskRegdate,
                    task_writer taskWriter,
               project_no projectNo
         from task
         where task_no = #{taskNo};
      ]]>
   </select>
   
   <!-- 테스크 삭제 -->
   <update id="taskDelete" parameterType="Long">
      <![CDATA[ 
         update task
         set task_state = 'del'
         where task_no = #{reOrderTask}
      ]]>
   </update>
   
   <!-- 테스크 복사 -->
   <insert id="copyTask" parameterType="copytaskvo">
      <![CDATA[
         INSERT INTO task (task_no, task_start, task_end, task_point, task_label, task_state, task_contents, task_order, task_regdate, tasklist_no, project_no, task_writer)
         SELECT null task_no, task_start, task_end, task_point, task_label, task_state, concat(task_contents,'_copy'), task_order, now() task_regdate, tasklist_no, project_no, #{taskWriter} task_writer
         FROM task 
         WHERE task_no = #{originalTaskNo} 
      ]]>
   <selectKey keyProperty = "taskNo" resultType="long" order="AFTER">
      select last_insert_id()
   </selectKey>
   </insert>
   
   <!-- 테스크 복사 (태그) -->
   <insert id="copyTag" parameterType="taglistvo">
      <![CDATA[
         INSERT INTO tagtask 
         values(#{tagNo},#{taskNo})
      ]]>
   </insert>   
   
   <!-- 테스크 복사 (멤버) -->
   <insert id="copyUser" parameterType="uservo">
      <![CDATA[
         INSERT INTO taskuser 
         values(#{userNo},#{roleNo})
      ]]>
   </insert>   
   
   <!-- 테스크 복사 (체크리스트) -->
   <insert id="copyCheckList" parameterType="checklistvo">
      <![CDATA[
         insert into checklist 
         values(null, #{checklistContents}, #{checklistState}, #{taskNo})
      ]]>
   </insert>   
   
   <!-- 테스크 DnD 정렬 update -->
   <update id="taskDnDReOrder" parameterType="taskvo">
      <![CDATA[ 
         update task
         set task_order = #{taskOrder}
         where task_no = #{taskNo}
      ]]>
   </update>
   
   <!-- 테스크 DnD 정렬 update -->
   <update id="taskInTaskListNoChange" parameterType="taskreordervo">
      <![CDATA[ 
         update task
         set tasklist_no = #{endTaskListNo}
         where task_no = #{reOrderTask}
      ]]>
   </update>
   
   <!-- 테스크 체크 update -->
   <update id="taskStateUpdate" parameterType="taskvo">
      <![CDATA[ 
         update task
         set task_state = #{taskState}, task_order = #{taskOrder}
         where task_no = #{taskNo}
      ]]>
   </update>
   
	<!-- 업무 날짜 변경 -->
   <update id="taskDateUpdate" parameterType="taskvo">
      <![CDATA[ 
         update task
         set task_start = #{taskStart}, task_end = #{taskEnd}
         where task_no = #{taskNo}
      ]]>
   </update>
  
    <!-- 태스트 멤버 insert -->
   <insert id="insertTaskUser" parameterType="taskuservo">
      <![CDATA[
         insert into taskuser
         values(#{userNo}, #{taskNo})
      ]]>
   </insert> 
   
   <!-- 태스트 멤버 delete -->
   <delete id="deleteTaskUser" parameterType="taskuservo">
      <![CDATA[ 
         delete from taskuser
         where task_no = #{taskNo} and user_no = #{userNo}
      ]]>
   </delete>  
   
   
   <!-- 간트차트용 selectAllTasksByProjectNo -->
      <select id="selectAllTasksByProjectNo" resultType="taskvo">
      <![CDATA[
         select t.task_no taskNo,
               date_format(t.task_start, '%Y-%m-%d') as taskStart,
               date_format(t.task_end, '%Y-%m-%d') as taskEnd,
               t.task_point taskPoint,
               t.task_label taskLabel,
               t.task_state taskState,
               t.task_contents taskContents,
               t.task_order taskOrder,
               t.tasklist_no tasklistNo,
               tl.tasklist_order tasklistOrder,
               t.task_regdate taskRegdate,
               t.task_writer taskWriter,
               t.project_no projectNo
         from task t
         join tasklist tl on tl.tasklist_no = t.tasklist_no
         where t.project_no = #{projectNo}
         order by tl.tasklist_order asc, t.task_order desc
      ]]>
   </select>
   <!-- 프로젝트 회원별 권한 -->
  <select id="selectAuthUserRole" parameterType="HashMap" resultType="Long">
  	<![CDATA[
  		select up.role_no
		from user u
		join userproject up using(user_no)
		where u.user_no = #{authUserNo}
		and up.project_no = #{projectNo}
  	]]>
  </select>
  
  <!-- 태그 검색될 테스크 번호 -->
  <select id="searchTag" parameterType="HashMap" resultType="HashMap">
  	  <![CDATA[
         select distinct c.task_no
         from project a
         join tasklist b on(a.project_no = b.project_no)
         join task c on (b.tasklist_no = c.tasklist_no)
         join tagtask d on(c.task_no = d.task_no)
         join taglist e on(d.tag_no = e.tag_no)
         where a.project_no = #{projectNo}
         and e.tag_name like CONCAT('%',#{keyword},'%')
  	]]>
  </select>

</mapper>
