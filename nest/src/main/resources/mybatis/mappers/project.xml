<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="project">
	<select id="selectPro" parameterType="long" resultType="projectvo">
	<![CDATA[
		select  p.project_no as projectNo, 
				p.project_title as projectTitle,
        		p.project_desc as projectDesc,
        		date_format(p.project_start, '%Y-%m-%d %H:%m') as projectStart,
        		date_format(p.project_end, '%Y-%m-%d %H:%m') as projectEnd,
				p.project_state as projectState,
        		date_format(p.project_regdate, '%Y-%m-%d %H:%m') as projectRegDate,
        		p.project_writer as projectWriter,
        		u.user_name as projectWriterName
		from project p
		join user u on p.project_writer = u.user_no
		join userproject up on p.project_no = up.project_no
		where up.user_no = #{authUserNo};
 		]]> 
	</select>
	<insert id="insertProjectNotMember" parameterType="projectvo">
	<![CDATA[
	insert into project values (null, #{projectTitle}, #{projectDesc}, #{projectStart}, #{projectEnd}, #{projectState}, #{projectRegDate}, #{projectWriter})
	]]>
	<selectKey keyProperty = "projectNo" resultType="long" order="AFTER">
		select last_insert_id()
	</selectKey>
	</insert>
	
	<select id="selectUser" parameterType="map" resultType="uservo">
	<![CDATA[
	select userproject.user_no as userNo, role_no as roleNo, user_name as userName, user_email as userEmail, user_photo as userPhoto
	from project, userproject, user
	where project.project_no = userproject.project_no
	and userproject.user_no = user.user_no
	and project.project_no = #{projectNo}
	and user.user_no != #{userNo}
	]]>
	</select>
	
	<select id="selectProjectMember" parameterType="long" resultType="uservo">
		<![CDATA[
			select a.user_no as userNo, 
				   a.user_name as userName,
				   a.user_email as userEmail,
                   a.user_title as userTitle,
                   a.user_dept as userDept,
                   a.user_regdate as userRegdate,
				   a.user_photo as userPhoto,
                   a.user_birth as userBirth,
				   b.project_no as projectNo
			from user a, userproject b
			where a.user_no = b.user_no 
				  and project_no = #{projectNo};
		]]>
	</select>
	
	<insert id="insertAuthUser" parameterType="map">
	<![CDATA[
	insert into userproject values (#{projectNo}, #{userNo}, 1)
	]]>
	</insert>
	
	<insert id="insertUserProject" parameterType="map">
	<![CDATA[
	insert into userproject values (#{projectNo}, #{userNo}, 3)
	]]>
	</insert>
	
	<insert id="userAdd" parameterType="userprojectvo">
	<![CDATA[
	insert into userproject values (#{projectNo}, #{userNo}, 3)
	]]>
	</insert>
	
	<delete id="userDelete" parameterType="userprojectvo">
	<![CDATA[
	delete from userproject where project_no = #{projectNo} and user_no = #{userNo}
	]]>
	</delete>
	
	<insert id="userInsert" parameterType="uservo">
	<![CDATA[
	insert into user values (null, now(), #{userEmail}, #{userName}, "", null, null, null, null, "korea", #{userPhoto}, null, "준회원")
	]]>
	<selectKey keyProperty = "userNo" resultType="long" order="AFTER">
		select last_insert_id()
	</selectKey>
	</insert>
	
	<insert id="userProjectJoin" parameterType="uservo">
	<![CDATA[
	insert into userproject values (#{projectNo}, #{userNo}, 3)
	]]>
	</insert>
	
	<update id="titleUpdate" parameterType="projectvo">
	<![CDATA[
	update project set project_title = #{projectTitle} where project_no = #{projectNo}
	]]>
	</update>
	
	<update id="descUpdate" parameterType="projectvo">
	<![CDATA[
	update project set project_desc = #{projectDesc} where project_no = #{projectNo}
	]]>
	</update>
	
	<update id="stateUpdate" parameterType="projectvo">
	<![CDATA[
	update project set project_state = #{projectState} where project_no = #{projectNo}
	]]>
	</update>
</mapper>
