<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="project">
	<select id="selectPro" parameterType="long" resultType="projectvo">
	<![CDATA[
		select  p.project_no as projectNo, 
				p.project_title as projectTitle,
		        p.project_desc as projectDesc,
		        date_format(p.project_start, '%Y-%m-%d') as projectStart,
		        date_format(p.project_end, '%Y-%m-%d') as projectEnd,
				p.project_state as projectState,
		        date_format(p.project_regdate, '%Y-%m-%d %H:%m') as projectRegDate,
		        p.project_writer as projectWriter,
		        u.user_name as projectWriterName,
		        d.taskCount as taskCount,
		        d.completedTask as completedTask,
		        up.role_no as roleNo
		from project p
		join user u on p.project_writer = u.user_no
		join userproject up on p.project_no = up.project_no 
		left join (select a.project_no, ifnull(taskCount, 0) as taskCount, ifnull(completedTask, 0) as completedTask
					from project as a
					left outer join (select project_no, count(task_no) as taskCount, task_state
					from task
					where task_state != "del"
					group by project_no
					having task_state != "del") as b
					on a.project_no = b.project_no left outer join (select project.project_no, count(if(task_state = 'done',1,null)) as completedTask
																		from project join task
																		on project.project_no = task.project_no
																		group by project_no) as c
																		on b.project_no = c.project_no) as d
		on p.project_no = d.project_no
		where up.user_no = #{authUserNo}
 		]]> 
	</select>
	<insert id="insertProjectNotMember" parameterType="projectvo">
	<![CDATA[
	insert into project values (null, #{projectTitle}, #{projectDesc}, #{projectStart}, #{projectEnd}, #{projectState}, #{projectRegDate}, #{projectWriter})
	]]>
	<selectKey keyProperty = "projectNo" resultType="long" order="AFTER">
		select last_insert_id()
	</selectKey>
	</insert>
	
	<select id="selectUser" parameterType="map" resultType="uservo">
	<![CDATA[
	select userproject.user_no as userNo, role_no as roleNo, user_name as userName, user_email as userEmail, user_photo as userPhoto
	from project, userproject, user
	where project.project_no = userproject.project_no
	and userproject.user_no = user.user_no
	and project.project_no = #{projectNo}
	]]>
	</select>
	
	<select id="selectProjectMember" parameterType="long" resultType="uservo">
		<![CDATA[
			select a.user_no as userNo, 
				   a.user_name as userName,
				   a.user_email as userEmail,
                   a.user_title as userTitle,
                   a.user_dept as userDept,
                   a.user_regdate as userRegdate,
				   a.user_photo as userPhoto,
                   a.user_birth as userBirth,
                   b.role_no as roleNo,
				   b.project_no as projectNo
			from user a, userproject b
			where a.user_no = b.user_no 
				  and project_no = #{projectNo};
		]]>
	</select>
	
	<insert id="insertAuthUser" parameterType="map">
	<![CDATA[
	insert into userproject values (#{projectNo}, #{userNo}, 1)
	]]>
	</insert>
	
	<insert id="insertUserProject" parameterType="map">
	<![CDATA[
	insert into userproject values (#{projectNo}, #{userNo}, 3)
	]]>
	</insert>
	
	<insert id="userAdd" parameterType="userprojectvo">
	<![CDATA[
	insert into userproject values (#{projectNo}, #{userNo}, 3)
	]]>
	</insert>
	
	<delete id="userDelete" parameterType="userprojectvo">
	<![CDATA[
	delete from userproject where project_no = #{projectNo} and user_no = #{userNo}
	]]>
	</delete>
	
	<insert id="userInsert" parameterType="uservo">
	<![CDATA[
	insert into user values (null, now(), #{userEmail}, #{userName}, "", null, null, null, null, "korea", #{userPhoto}, null, "준회원", null)
	]]>
	<selectKey keyProperty = "userNo" resultType="long" order="AFTER">
		select last_insert_id()
	</selectKey>
	</insert>
	
	<insert id="userProjectJoin" parameterType="uservo">
	<![CDATA[
	insert into userproject values (#{projectNo}, #{userNo}, 3)
	]]>
	</insert>
	
	<update id="titleUpdate" parameterType="projectvo">
	<![CDATA[
	update project set project_title = #{projectTitle} where project_no = #{projectNo}
	]]>
	</update>
	
	<update id="descUpdate" parameterType="projectvo">
	<![CDATA[
	update project set project_desc = #{projectDesc} where project_no = #{projectNo}
	]]>
	</update>
	
	<update id="stateUpdate" parameterType="projectvo">
	<![CDATA[
	update project set project_state = #{projectState} where project_no = #{projectNo}
	]]>
	</update>
	

	<!-- 프로젝트 마감 날짜 업데이트 -->
	<update id="projectDateUpdate" parameterType="projectvo">
	<![CDATA[
	update project 
	set project_start = #{projectStart} , project_end = #{projectEnd} 
	where project_no = #{projectNo}
	]]>
	</update>

	<!-- 프로젝트 별 파일 select -->
	<select id="selectFile" parameterType="long" resultType="filevo">
		<![CDATA[
			select distinct 
					a.task_no as taskNo,
					a.task_contents as taskContents,
					b.file_no as fileNo, 
			        b.file_path as filePath, 
			        b.origin_name as originName,
			        b.file_regdate as fileRegdate,
			        c.project_no as projectNo,
			        c.project_title as projectTitle,
			        e.user_no as userNo,
			        e.user_name as userName,
			        f.tasklist_no as tasklistNo,
			        f.tasklist_name as tasklistName,
			        d.comment_no as commentNo
			from task a
			join file b on(a.task_no = b.task_no)
			join project c on(a.project_no = c.project_no)
			join comment d on(b.file_no = d.file_no)
			join user e on(d.user_no = e.user_no)
			join tasklist f on(f.tasklist_no = a.tasklist_no)
			where a.project_no=#{projectNo}
		]]>
	</select>

	<update id="userProjectUpdate" parameterType="projectvo">
		<![CDATA[
			update userproject set role_no = 1 where user_no = #{userNo} and project_no = #{projectNo}
		]]>
	</update>

	<delete id="userProjectDelete" parameterType="projectvo">
		<![CDATA[
			delete from userproject where user_no = #{sessionUserNo} and project_no = #{projectNo}
		]]>
	</delete>
	
	<delete id="notTransferDelete" parameterType="projectvo">
		<![CDATA[
			delete from userproject where user_no = #{sessionUserNo} and project_no = #{projectNo}
		]]>
	</delete>
	
	<delete id="foreverdelete" parameterType="projectvo">
		<![CDATA[
			delete from project where project_no = #{projectNo}
		]]>
	</delete>
</mapper>
